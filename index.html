<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My music game</title>
</head>

<body>
    <style>
        html {
            background-color:rgb(32, 37, 44);
        }
        button {
            background-color: rgb(0, 217, 255);
            height: 40px;
            width: 40px;            
        }

        button:hover{
            background-color: rgb(150, 217, 255);
        }
        button:active{
            background-color: rgb(200, 255, 255);
        }

        .right_answer:active {
            background-color: green;
        }

        .wrong_answer:active {
            background-color: red;
        }

        p {
            color: white;
        }

        #start {
            width: 50px;
            background-color: gray;
            text-align: center;
        }

        div{
            text-align: center;
        }

    </style>

    <div>
        <input type="checkbox" id="play_sound_checkbox" name="play_sound"
            checked>
        <label for="scales">Play sound on button click</label>
    </div>
  

    <div id="start-div">
        <button id="start">start</button>
        <!-- <button id="listen">listen</button> -->
    </div>
    <div>
        

        <button id="do" data-note="">Do</button>
        <button id="re" data-note="">Re</button>
        <button id="mi" data-note="">Mi</button>
        <button id="fa" data-note="">Fa</button>
        <button id="so" data-note="">So</button>
        <button id="la" data-note="">La</button>
        <button id="ti" data-note="">Ti</button>
        <button id="DO" data-note="">Do</button>
    </div>
    <div><p id="answer_p">Click start</p></div>

    <div style="text-align: left;">
        <h3>To do</h3>
        <ul>
            <li> Fix the sequence playing and the waiting time before next game starts</li>
            <li> Add a button to play the cadence</li>
            <li> Add a slider to define how often to play the cadence</li>
            <li> Add a check box to play the sequence back to DO</li>
            <li>implement the playing of the sequence back to DO</li>
            <li>implement the playing of the cadence</li>
            <li> <strike>Add a check box to play or not the buttons on click</strike></li>
        </ul>
    </div>


    
</body>

</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.32/Tone.js"></script>
<script src="scripts/sound.js"></script>
<script>
    const synth = new Tone.Synth().toDestination();    
    let answer_p = document.getElementById('answer_p');
    // Button event listeners
    let notes    = ['do', 're', 'mi', 'fa', 'so', 'la', 'ti', 'DO'];
    let note2ind = {};
    for (let i=0; i<notes.length;i++) {
        note2ind[notes[i]] = i;
    }
    let midi_num = [60, 62, 64, 65, 67, 69, 71, 72];
    let note_names = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
    
    let I;

    document.getElementById('start').onclick = start;
    
    for (let i=0; i<notes.length;i++) {
            let m = midi_num[i];
            let elem = document.getElementById(notes[i])
            elem.dataset.note = note_names[i];
            elem.onclick = answer;
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function start(){
        // Tone.start();
        Tone.Transport.start()
        new_game();
        let elem = document.getElementById('start');
        elem.onclick =  listen;
        elem.innerHTML = "listen";
        
    }
    // Setup state
    function new_game() {
        console.log("New game");
        console.log("---");
        answer_p.innerHTML= "Hmmmm....";
        console.log(Tone.Transport.state)


        I = getRandomInt(notes.length-1); // random number
        
        synth.triggerAttackRelease(note_names[I], '4n');
        
        for (let i=0; i<notes.length;i++) {
            let elem = document.getElementById(notes[i]);
            // clean
            if (elem.classList.contains("right_answer")) {
                elem.classList.remove("right_answer")
            }
            if (elem.classList.contains("wrong_answer")) {
                elem.classList.remove("wrong_answer")
            }

            // modify classes based on the note to guess
            if (i==I){
                elem.classList.add("right_answer");
            } else {
                elem.classList.add("wrong_answer");
            }   
        }
    }

    function answer() {
        console.log("answer");
        let play_sound = document.getElementById('play_sound_checkbox').checked;
        
        if (this.classList.contains("right_answer")) {
            console.log("Bravo");
            answer_p.innerHTML= "Bravo!";
            // 
            wait_time = play_end_sequence ();
            setTimeout(() => {  new_game(); }, wait_time);
            // new_game();
        } else if (this.classList.contains("wrong_answer")) {
            if (play_sound) {
                synth.triggerAttackRelease(this.dataset.note, '4n');
            }
            console.log("Booboo");
            answer_p.innerHTML= "Booboo!";
        } else {
            console.log("The class of this button is unknown, or unset.")
        }
    }
    
    function listen(){
        console.log(I);
        synth.triggerAttackRelease(note_names[I], '4n');
    }

    function play_end_sequence () {
        let wait_time=0;
        let now = Tone.now()
        let note_seq = [];
        note_length = 0.75;

        let i_end, i_mod;
        if (I<4) {
            i_end = -1;  i_mod = -1;
        } else {
            i_end =8;  i_mod = 1;   
        }
        console.log(i_end, i_mod)
        for (let i=I; i!==i_end; i+=i_mod) {
            console.log(i);
            note_seq.push([wait_time, note_names[i]]);
            wait_time+=note_length;
        }
        
        const seq = new Tone.Part(
            (time, note) => {synth.triggerAttackRelease(note, 0.8*note_length, time);}, 
            note_seq,
            );
        seq.start();
        console.log(Tone.Transport.state);
        
        Tone.Transport.start();
        return Tone.Transport.toSeconds(wait_time+1.0)*1000
        
    }

</script>