<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My music game</title>
    <link rel="stylesheet" href="styles/styles.css">
</head>

<body>

    <div style="text-align: left; margin-left:100px">
        <input type="checkbox" id="play_sound_checkbox" name="play_sound"
            checked>
        <label for="play_sound">Play sound on button click</label>
        <br>
        <input type="checkbox" id="play_end_sequence_checkbox" name="play_end_sequence"
            checked>
        <label for="play_end_sequence">Play the sequence to DO</label>
        
            
        <form id="game_form" style="text-align: left;"></form>
                Game type:
            <input type="radio" id="game_radio_note" name="game_radio" value="note"
                checked>
            <label for="game_radio_note">Note</label>
            <input type="radio" id="game_radio_chord" name="game_radio" value="chord">
            <label for="game_radio_chord">Chord</label>
        </form>
        
        

    </div>
  
    <br>
    <div id="start-div">
        <button id="start" class="start"><span class=greeting_emoji></span><br>start</button>
    </div>
    <br>
    <div class='div-note'>
        <button id="do" class="note" data-note="" data-I="0">Do</button>
        <button id="re" class="note" data-note="" data-I="1">Re</button>
        <button id="mi" class="note" data-note="" data-I="2">Mi</button>
        <button id="fa" class="note" data-note="" data-I="3">Fa</button>
        <button id="so" class="note" data-note="" data-I="4">So</button>
        <button id="la" class="note" data-note="" data-I="5">La</button>
        <button id="ti" class="note" data-note="" data-I="6">Ti</button>
        <button id="DO" class="note" data-note="" data-I="7">Do</button>
    </div>

    </br>
    <div>
        <button id="cadence" class="cadence">Play cadence</button> 
        
    </div>
    <div><p id="answer_p">...</p></div>

    <br>

    <div style="text-align: left;">
        <h3>To do</h3>
        <ul>
            <li>Implement inversion and voice leading for chords (high proba for best voice leading, and lower proba for others (if always best, it will just be stuck in whatever inversion it started))</li>
            <li>Get a dictionary of guitar chords (e.g. diatonic in E major)</li>
            <li>Implement markov chain to get more natural chord progressions</li>

            
            
            <li>play bass note in different instrument (+add option) for chord game</li>
            <li>slider for volume of bass note</li>


            <li> Add a slider to define how often to play the cadence</li>
            <li>add a slider for the waiting time before the next game</li>
            <li> block button clicks while the sequence is playing </li>
        </ul>
        
    </div>


    
</body>

</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.32/Tone.js"></script>
<script src="scripts/sound.js"></script>
<script src="scripts/synths.js"></script>
<script src="scripts/utils.js"></script>
<script>
    


    // Useful variables
    // =====================================
    let answer_p = document.getElementById('answer_p');
    let notes    = ['do', 're', 'mi', 'fa', 'so', 'la', 'ti', 'DO'];
    let midi_num = [60, 62, 64, 65, 67, 69, 71, 72];
    let note_names = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
    let chords = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°', 'I'];
    let chord_names = [ 'C4 E4 G4', 
                        'D4 F4 A4', 
                        'E4 G4 B4', 
                        'F4 A4 C5', 
                        'G4 B4 D5', 
                        'A4 C5 E5', 
                        'B4 D5 F5',
                        'C5 E5 G5' ];
    let I_noteToGuess = getRandomInt(notes.length-1); // random number

    let previous_chord = 'C4 E4 G4';
    let current_chord = 'G4 B4 D5';

    let prev_chord_array = previous_chord.split(' ');
    let curr_chord_array = current_chord.split(' ');
    let prev = [0, 0, 0];
    let curr = [0,0,0];
    for (i=0; i<3; i++) {
        prev[i] = noteName2MidiNum[prev_chord_array[i]];// % 12; // ideally should use distance in terms of chord degree rather than chromatic distance
        curr[i] = noteName2MidiNum[curr_chord_array[i]];// % 12;
    }


    let score;
    let min_score = 1e100;
    let I_best;
    // for (i_inv=0; i_inv<3; i_inv++){

    
        // score = arrSum(prev.map((p, ind) => {
        //     let dist = curr[(ind+i_inv)%3]-p;
        //     return Math.min(Math.abs(dist), Math.abs(dist-12), Math.abs(dist+12));    
        // }));

        let scores = [0,0,0]
        curr_inv0 = [curr[0], curr[1], curr[2]];
        curr_inv1 = [curr[1], curr[2], curr[0]+12];
        curr_inv2 = [curr[2], curr[0]+12, curr[1]+12];

        dist_upper_inv0 = (curr_inv0[2]-prev[2])%12
        dist_upper_inv1 = (curr_inv1[2]-prev[2])%12
        dist_upper_inv2 = (curr_inv2[2]-prev[2])%12

        curr_inv0 = curr_inv0.map(x => x-curr_inv0[2]+dist_upper_inv0+prev[2]);
        curr_inv1 = curr_inv1.map(x => x-curr_inv1[2]+dist_upper_inv1+prev[2]);
        curr_inv2 = curr_inv2.map(x => x-curr_inv2[2]+dist_upper_inv2+prev[2]);

        scores[0] = arrSum(prev.map((p, ind) => {
            let dist = curr_inv0[ind]-p;
            return Math.min(Math.abs(dist), Math.abs(dist-12), Math.abs(dist+12));    
        }));
        scores[1] = arrSum(prev.map((p, ind) => {
            let dist = curr_inv1[ind]-p;
            return Math.min(Math.abs(dist), Math.abs(dist-12), Math.abs(dist+12));    
        }));
        scores[2] = arrSum(prev.map((p, ind) => {
            let dist = curr_inv2[ind]-p;
            return Math.min(Math.abs(dist), Math.abs(dist-12), Math.abs(dist+12));    
        }));


        // if (score<min_score) {
        //     min_score = score;
        //     I_best = i_inv;
        // }
    // }
    console.log(I_best)
    console.log("scores", scores)
    // curr = curr.map((x,i) => curr[(i+I_best)%3]);
    console.log("prev", prev);
    console.log("curr", curr);
    console.log(curr_inv0);
    console.log(curr_inv1);
    console.log(curr_inv2);
    
    let I = argMin(curr.map(x => x - prev[prev.length-1]))
    console.log("best top note: ", curr[I]);


    // Set up key and mouse event handlers
    // =====================================
    document.getElementById('start').onclick = start;
    document.getElementById('cadence').onclick = play_cadence;
    document.getElementById('game_radio_note').onclick = init_game_type;
    document.getElementById('game_radio_chord').onclick = init_game_type;
    for (let i=0; i<notes.length;i++) {
            let m = midi_num[i];
            let elem = document.getElementById(notes[i])
            elem.dataset.note = note_names[i];
            elem.onmousedown = answer;
            document.addEventListener('keypress', logKey);
    }

    function logKey(e) {
        let textContent = ` ${e.code}`;
        key = Number(`${e.key}`);
        console.log(textContent, key);
        document.getElementById(notes[key-1]).onmousedown();
    }

    // Game type
    // =====================================
    function init_game_type() {
        answer_p.innerText =  this.value;
        console.log("change game type");
        for (let i=0; i<notes.length;i++) {
            let m = midi_num[i];
            let elem = document.getElementById(notes[i])
            if (this.value=='note') {
                elem.innerText = notes[i];
                elem.dataset.note = note_names[i];
                elem.style.fontVariantCaps = "";
            }
            else {
                elem.innerText = chords[i];
                elem.dataset.note = chord_names[i];
                elem.style.fontVariantCaps = "normal";
            }
            
            elem.onmousedown = answer;
            document.addEventListener('keypress', logKey);
    }
    }

    // Start
    // =====================================
    function start(){
        Tone.Transport.start();
        new_game();
        document.getElementById('start').onclick =  new_game.bind(null, false);;
    }


    // New game
    // =====================================
    function new_game(new_I=true) {
        console.log("New game");
        console.log("---");
        document.getElementById('start').innerHTML = "ヾ(´〇`)ﾉ♪♪♪";
        document.getElementById('start').className="new_game";

        if (new_I) {
            I_noteToGuess = getRandomInt(notes.length-1); // random number
        }
                
        // Assign right/wrong_answer class to buttons
        for (let i=0; i<notes.length;i++) {
            let elem = document.getElementById(notes[i]);
            elem.className = "note"; // clear the classList
            if (i==I_noteToGuess){
                elem.classList.add("right_answer");
                synthRight.triggerAttackRelease(elem.dataset.note.split(' '), '4n');
            } else {
                elem.classList.add("wrong_answer");
            }   
        }
        setTimeout(() => {  document.getElementById('start').innerHTML= "<span class=wondering_emoji></span><br>listen again?"; document.getElementById('start').className="wonder";}, 1000);
    }

    // Answer
    // =====================================
    function answer() {
        console.log("answer");
        let this_note = this.dataset.note.split(' ');
        this.classList.add("revealed");
        if (this.classList.contains("right_answer")) {
            console.log("Bravo");
            document.getElementById('start').innerHTML= "＼(＾▽＾)／";
            document.getElementById('start').className="right_answer";
            this.classList.add("revealed");
            if (document.getElementById('play_end_sequence_checkbox').checked) { 
                wait_time = play_end_sequence ();
            } else {
                if (document.getElementById('play_sound_checkbox').checked) {
                    synthRight.triggerAttackRelease(this_note, '4n');
                } 
                wait_time = 1.0*1000.0;
            } 
            setTimeout(() => {  new_game(); }, wait_time);
        } else if (this.classList.contains("wrong_answer")) {
            if (document.getElementById('play_sound_checkbox').checked) { 
                synthWrong.triggerAttackRelease(this_note, '4n');
            }
            console.log("Booboo"); 
            document.getElementById('start').innerHTML= "(＞﹏＜)";
            document.getElementById('start').className="wrong_answer"; 
            document.getElementById('start').style.animation="none"; // next 3 lines restart animatino
            document.getElementById('start').offsetHeight;
            document.getElementById('start').style.animation=""; 
             
            this.classList.add("revealed"); 
        } else {
            synthWrong.triggerAttackRelease(this_note, '4n');
            console.log("The class of this button is unknown, or unset.")
        }
    }
    
    
    // Sequence
    // =====================================
    function play_end_sequence () {
        console.log("end sequence")
        let wait_time=0;
        let now = Tone.now()
        let note_seq = [];
        let indices = [];
        let note_length = 0.75;

        let i_end, i_mod;
        if (I_noteToGuess<4) {
            i_end = -1;  i_mod = -1;
        } else {
            i_end =8;  i_mod = 1;   
        }

        for (let i=I_noteToGuess; i!==i_end; i+=i_mod) {
            console.log(i);
            indices.push(i);
            note_seq.push([wait_time, note_names[i]]);
            wait_time+=note_length;
        }
        
        let counter = 0
        const seq = new Tone.Part(
            (time, note) => {
                synthRight.triggerAttackRelease(note, 0.8*note_length, time);
                console.log("event!!", counter, time, note);
                let cl = document.getElementById(notes[indices[counter]]).classList;
                if (cl.contains("wrong_answer")) {
                    document.getElementById(notes[indices[counter]]).className = "note sequence";
                }
                counter++;
            }, 
            note_seq,
        ).start();
        console.log(Tone.Transport.state);
        
        return Tone.Transport.toSeconds(wait_time+1.0)*1000
    }

    // Cadence
    // =====================================
    function play_cadence() {
        answer_p.innerText = "Cadence";
        let note_length = 0.75;
        console.log("cadence");

        const seq = new Tone.Part (
            (time, note) => {
                synthRight.triggerAttackRelease(note, 0.8*note_length, time);                
            }, 
            [[note_length*0, ['E3', 'E4', 'G4', 'C5']], 
             [note_length*1, ['F3', 'D4', 'A4', 'C5']],
             [note_length*2, ['G3', 'D4', 'G4', 'B4']],
             [note_length*3, ['C3', 'E4', 'G4', 'C5']]]
        ).start();        
    }

</script>