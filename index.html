<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My music game</title>
    <link rel="stylesheet" href="styles/styles.css">
</head>

<body>

    <div style="text-align: left; margin-left:100px">
        <input type="checkbox" id="play_sound_checkbox" name="play_sound"
            checked>
        <label for="play_sound">Play sound on button click</label>
        <br>
        <input type="checkbox" id="play_end_sequence_checkbox" name="play_end_sequence"
            checked>
        <label for="play_end_sequence">Play the sequence to DO</label>
    </div>
  
    <br>
    <div id="start-div">
        <button id="start" class="start"><span class=greeting_emoji></span><br>start</button>
    </div>
    <br>
    <div class='div-note'>
        <button id="do" class="note" data-note="" data-I="0">Do</button>
        <button id="re" class="note" data-note="" data-I="1">Re</button>
        <button id="mi" class="note" data-note="" data-I="2">Mi</button>
        <button id="fa" class="note" data-note="" data-I="3">Fa</button>
        <button id="so" class="note" data-note="" data-I="4">So</button>
        <button id="la" class="note" data-note="" data-I="5">La</button>
        <button id="ti" class="note" data-note="" data-I="6">Ti</button>
        <button id="DO" class="note" data-note="" data-I="7">Do</button>
    </div>
    <!-- <div><p id="answer_p">Click start</p></div> -->

    <br>

    <div style="text-align: left;">
        <h3>To do</h3>
        <ul>
            
            
            
            
            <li> block button clicks while the sequence is playing </li>
            <li> print "listen again" in start button on hover</li>
            <li> implement the playing of the cadence</li>
            <li> Add a button to play the cadence</li>
            <li> Add a slider to define how often to play the cadence</li>
            <li> <strike>shake the emoji (or the div) when a wrong note is played</strike> </li>
            <li> <strike>change the color of the start button depending on emoji</strike></li>
            <li> <strike>flash the wrong note</strike> </li>
            <li> <strike>leave the note in red when a wrong answer is inputted</strike> </li>
            <li> <strike>animate the sequence to flash when the note is played</strike></li>
            <li> <strike>Add a check box to play the sequence back to DO</strike></li>
            <li> <strike>light up the buttons when the end sequence is played</strike></li>
            <li> <strike>implement the playing of the sequence back to DO</strike></li>
            <li ><strike>Fix the sequence playing and the waiting time before next game starts</strike></li>
            <li ><strike>Add a check box to play or not the buttons on click</strike></li>
        </ul>
    </div>


    
</body>

</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.32/Tone.js"></script>
<script src="scripts/sound.js"></script>
<script>
    const synthRight = new Tone.Synth().toDestination();
    const synthWrong = new Tone.Synth().toDestination();

    let answer_p = document.getElementById('answer_p');
    // Button event listeners
    let notes    = ['do', 're', 'mi', 'fa', 'so', 'la', 'ti', 'DO'];
    let note2ind = {};
    for (let i=0; i<notes.length;i++) {
        note2ind[notes[i]] = i;
    }
    let midi_num = [60, 62, 64, 65, 67, 69, 71, 72];
    let note_names = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
    
    let I;

    document.getElementById('start').onclick = start;
    



    for (let i=0; i<notes.length;i++) {
            let m = midi_num[i];
            let elem = document.getElementById(notes[i])
            elem.dataset.note = note_names[i];
            elem.onmousedown = answer;
    }

    // function play_note() {
    //     console.log("play_sound", play_sound)
    //     if (play_sound) {
    //         synthRight.triggerAttack(this.dataset.note);
    //     }
    // }
    // function stop_note() {
    //     if (play_sound) {
    //         synthRight.triggerRelease();
    //     }
    // }

    function getRandomInt(max) {
        return Math.round(Math.random() * max);
    }

    function start(){
        
        // Tone.start();
        Tone.Transport.start()
        // wait_time = play_end_sequence ();

        new_game();
        document.getElementById('start').onclick =  listen;
        
    }
    // Setup state
    function new_game(new_I=true) {
        console.log("New game");
        console.log("---");
        // answer_p.innerHTML= "Hmmmm....";
        
        
        console.log(Tone.Transport.state)

        if (new_I) {
            I = getRandomInt(notes.length-1); // random number
        }
        synthRight.triggerAttackRelease(note_names[I], '4n');
        // answer_p.innerHTML= "ヾ(´〇`)ﾉ♪♪♪";
        
        
        document.getElementById('start').innerHTML = "ヾ(´〇`)ﾉ♪♪♪";
        document.getElementById('start').className="new_game";
        setTimeout(() => {  document.getElementById('start').innerHTML= "<span class=wondering_emoji></span><br>listen again?"; document.getElementById('start').className="wonder";}, 1000);
        

        for (let i=0; i<notes.length;i++) {
            let elem = document.getElementById(notes[i]);
            elem.className = "note"; // clear the classList

            // modify classes based on the note to guess
            if (i==I){
                elem.classList.add("right_answer");
            } else {
                elem.classList.add("wrong_answer");
            }   
        }
    }

    function answer() {
        console.log("answer");
        
        this.classList.add("revealed");
        if (this.classList.contains("right_answer")) {
            console.log("Bravo");
            document.getElementById('start').innerHTML= "＼(＾▽＾)／";
            document.getElementById('start').className="right_answer";
            this.classList.add("revealed");
            if (document.getElementById('play_end_sequence_checkbox').checked) {
                wait_time = play_end_sequence ();
            } else {
                synthRight.triggerAttackRelease(this.dataset.note, '4n');
                wait_time = 2.0*1000.0;
            }
            setTimeout(() => {  new_game(); }, wait_time);
            // new_game();
        } else if (this.classList.contains("wrong_answer")) {
            if (document.getElementById('play_sound_checkbox').checked) {
                synthWrong.triggerAttackRelease(this.dataset.note, '4n');
            }
            console.log("Booboo");
            document.getElementById('start').innerHTML= "(＞﹏＜)";
            document.getElementById('start').className="wrong_answer";
            document.getElementById('start').style.animation="none";
            document.getElementById('start').offsetHeight;
            document.getElementById('start').style.animation="";
            // setTimeout(() => {  document.getElementById('start').className="wrong_answer"; }, 1);
            
            this.classList.add("revealed");
        } else {
            synthRight.triggerAttackRelease(this.dataset.note, '4n');
            console.log("The class of this button is unknown, or unset.")
        }
    }
    
    function listen(){
        console.log(I);
        new_game(new_I=false);
        // synthRight.triggerAttackRelease(note_names[I], '4n');
    }

    function play_end_sequence () {
        let wait_time=0;
        let now = Tone.now()
        let note_seq = [];
        let indices = [];
        note_length = 0.75;

        let i_end, i_mod;
        if (I<4) {
            i_end = -1;  i_mod = -1;
        } else {
            i_end =8;  i_mod = 1;   
        }
        console.log(i_end, i_mod)
        for (let i=I; i!==i_end; i+=i_mod) {
            console.log(i);
            indices.push(i);
            note_seq.push([wait_time, note_names[i]]);
            wait_time+=note_length;
        }
        
        let counter = 0
        const seq = new Tone.Part(
            (time, note) => {
                synthRight.triggerAttackRelease(note, 0.8*note_length, time);
                console.log("event!!", counter, time, note);
                let cl = document.getElementById(notes[indices[counter]]).classList;
                if (cl.contains("wrong_answer")) {
                    document.getElementById(notes[indices[counter]]).className = "note sequence";
                    // document.getElementById(notes[indices[counter]]).classList.add("sequence");
                }
                counter++;

                            }, 
            note_seq,
            );
        seq.start();
        console.log(Tone.Transport.state);
        
        Tone.Transport.start();
        return Tone.Transport.toSeconds(wait_time+1.0)*1000
        
    }

</script>